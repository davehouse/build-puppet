#!/usr/bin/env bash
# Verify command strings but do not eval them.

if echo "$SSH_ORIGINAL_COMMAND" | grep -Eq '^/usr/sbin/bless --netboot --server bsdp://(<%= scope.lookupvar("::config::mac_netboot_ips.join('|') %>); reboot$'; then
    install=$(echo "$SSH_ORIGINAL_COMMAND" | grep -Eo 'bsdp://[\.0-9]+')
    logger -s "Hardware controller requested netboot from ${install}"
    sudo /usr/sbin/bless --netboot --server "${install}"
    sudo reboot
elif echo "$SSH_ORIGINAL_COMMAND" | grep -Eq '^reboot$'; then
    logger -s "Hardware controller requested reboot"
    sudo reboot
else
    echo "Access denied"
    exit 1
fi
